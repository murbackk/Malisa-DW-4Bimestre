<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD Pedidos - Zênite</title>
    <link rel="stylesheet" href="/frontend/global.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
</head>
<body>
<header>
    <h1>CRUD Pedidos</h1>
    <a href="#" onclick="voltarDashboard()">← Voltar ao Dashboard</a>
</header>

<main>
    <section>
        <h2>Cadastro de Pedido</h2>

        <form id="pedidoForm">
            <div>
                <label for="searchId">Buscar por ID:</label>
                <div>
                    <input type="number" id="searchId" placeholder="Digite o ID para buscar">
                    <button type="button" id="btnBuscar">Buscar</button>

                    <button type="button" id="btnIncluir">Incluir</button>
                    <button type="button" id="btnAlterar" style="display:none;">Alterar</button>
                    <button type="button" id="btnExcluir" style="display:none;">Excluir</button>
                    <button type="button" id="btnSalvar" style="display:none;">Salvar</button>
                    <button type="button" id="btnCancelar">Cancelar</button>
                </div>
            </div>

            <fieldset id="formFields">
                <legend>Dados do Pedido</legend>

                <div>
                    <label for="idCliente">Cliente:</label>
                    <select id="idCliente" disabled>
                        <option value="">Selecione um cliente</option>
                    </select>
                </div>

                <div>
                    <label for="idUsuario">Funcionário:</label>
                    <select id="idUsuario" disabled>
                        <option value="">Selecione um funcionário</option>
                    </select>
                </div>

                <div>
                    <label>Valor Total:</label>
                    <input type="text" id="valorTotal" disabled readonly value="R$ 0,00">
                </div>
            </fieldset>

            <fieldset id="produtoFields">
                <legend>produto do Pedido</legend>

                <div>
                    <label for="produtoelect">Adicionar Produto:</label>
                    <select id="produtoelect" disabled>
                        <option value="">Selecione um produto</option>
                    </select>

                    <input type="number" id="quantidadeProduto" value="1" min="1" disabled>
                    <button type="button" id="btnAdicionarProduto" disabled>Adicionar</button>
                </div>

                <table id="produtoTable">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Preço Unit.</th>
                            <th>Qtd</th>
                            <th>Subtotal</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="produtoTableBody"></tbody>
                </table>
            </fieldset>
        </form>
    </section>

    <section>
        <h3>Lista de Pedidos</h3>
        <table id="pedidosTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Funcionário</th>
                    <th>Data</th>
                    <th>Valor Total</th>
                </tr>
            </thead>
            <tbody id="pedidosTableBody"></tbody>
        </table>
    </section>
</main>

<div id="messageContainer"></div>

<script>
const API_URL = "http://localhost:3001/pedido";

let produtoelecionados = [];
let listaproduto = [];
let listaClientes = [];
let listafuncionario = [];
let modoEdicao = false;
let pedidoAtual = null;

// DOM refs
const idCliente = document.getElementById("idCliente");
const idUsuario = document.getElementById("idUsuario");
const valorTotal = document.getElementById("valorTotal");
const produtoelect = document.getElementById("produtoelect");
const quantidadeProduto = document.getElementById("quantidadeProduto");
const produtoTableBody = document.getElementById("produtoTableBody");
const pedidosTableBody = document.getElementById("pedidosTableBody");
const searchId = document.getElementById("searchId");

// BOTÕES
const btnBuscar = document.getElementById("btnBuscar");
const btnIncluir = document.getElementById("btnIncluir");
const btnAlterar = document.getElementById("btnAlterar");
const btnExcluir = document.getElementById("btnExcluir");
const btnSalvar = document.getElementById("btnSalvar");
const btnCancelar = document.getElementById("btnCancelar");
const btnAdicionarProduto = document.getElementById("btnAdicionarProduto");

// ===================== INICIALIZAÇÃO =====================
document.addEventListener("DOMContentLoaded", () => {
    carregarTabela();
    carregarDadosAuxiliares();
    configurarEventos();
});

// Eventos
function configurarEventos() {
    btnBuscar.onclick = buscarPedido;
    btnIncluir.onclick = incluirPedido;
    btnAlterar.onclick = alterarPedido;
    btnExcluir.onclick = excluirPedido;
    btnSalvar.onclick = salvarPedido;
    btnCancelar.onclick = cancelarOperacao;
    btnAdicionarProduto.onclick = adicionarProduto;
}

// ===================== AUXILIARES =====================
async function carregarDadosAuxiliares() {
    try {
        // CLIENTES (vem do módulo pedido)
        const resClientes = await fetch(`${API_URL}/clientes`);
        listaClientes = await resClientes.json();

        idCliente.innerHTML = `<option value="">Selecione um cliente</option>`;
        listaClientes.forEach(c => {
            idCliente.innerHTML += `<option value="${c.idcliente}">${c.nomecliente}</option>`;
        });

        // FUNCIONÁRIOS (rota REAL do seu backend)
        const resFunc = await fetch("http://localhost:3001/funcionario");
        listafuncionario = await resFunc.json();

        idUsuario.innerHTML = `<option value="">Selecione um funcionário</option>`;
        listafuncionario.forEach(f => {
            idUsuario.innerHTML += `<option value="${f.idfuncionario}">${f.nomefuncionario} - ${f.nomecargo}</option>`;
        });

        // PRODUTOS (rota REAL do seu backend)
        const resproduto = await fetch("http://localhost:3001/produto");
        listaproduto = await resproduto.json();

        produtoelect.innerHTML = `<option value="">Selecione um produto</option>`;
        listaproduto.forEach(p => {
            produtoelect.innerHTML += `
                <option value="${p.idproduto}">
                    ${p.nomeproduto} - R$ ${parseFloat(p.precounitario).toFixed(2)}
                </option>`;
        });

    } catch (err) {
        console.error("Erro ao carregar dados auxiliares:", err);
    }
}


// ===================== BUSCAR PEDIDO =====================
async function buscarPedido() {
    const id = searchId.value;

    if (!id) {
        mostrarMensagem("Digite um ID.", "error");
        return;
    }

    try {
        const res = await fetch(`${API_URL}/${id}`);

        if (res.status === 404) {
            mostrarMensagem("Pedido não encontrado.", "error");
            return;
        }

        const data = await res.json();

        preencherFormulario(data);
        mostrarMensagem("Pedido carregado!", "success");
        mostrarBotoesEdicao();

    } catch (err) {
        console.error("Erro ao buscar pedido:", err);
    }
}

// ===================== FORMATAÇÃO =====================
function preencherFormulario(data) {
    const p = data.pedido;

    idCliente.value = p.idcliente;
    idUsuario.value = p.idusuario;

    produtoelecionados = data.produtos.map(prod => ({
        idProduto: prod.idproduto,
        nomeProduto: prod.nomeproduto,
        precoUnitario: parseFloat(prod.precounitario),
        quantidade: prod.quantidade
    }));

    atualizarTabelaproduto();
    calcularValorTotal();

    pedidoAtual = p;
}

// ===================== CRUD FRONT =====================
function incluirPedido() {
    limparFormulario();
    habilitarFormulario();
    modoEdicao = false;
    mostrarBotaoSalvar();
}

function alterarPedido() {
    if (!pedidoAtual) return mostrarMensagem("Selecione um pedido.", "error");

    habilitarFormulario();
    modoEdicao = true;
    mostrarBotaoSalvar();
}

async function excluirPedido() {
    if (!pedidoAtual) return;

    if (!confirm(`Excluir pedido #${pedidoAtual.idpedido}?`)) return;

    await fetch(`${API_URL}/${pedidoAtual.idpedido}`, { method: "DELETE" });

    mostrarMensagem("Pedido excluído!", "success");
    carregarTabela();
    cancelarOperacao();
}

async function salvarPedido() {
    if (!idCliente.value || !idUsuario.value) {
        mostrarMensagem("Selecione cliente e funcionário.", "error");
        return;
    }

    if (produtoelecionados.length === 0) {
        mostrarMensagem("Adicione produto.", "error");
        return;
    }

    const body = {
        idCliente: Number(idCliente.value),
        idUsuario: Number(idUsuario.value),
        produtos: produtoelecionados
    };

    let res;

    if (modoEdicao) {
        res = await fetch(`${API_URL}/${pedidoAtual.idpedido}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
    } else {
        res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
    }

    if (res.ok) {
        mostrarMensagem("Pedido salvo!", "success");
        carregarTabela();
        cancelarOperacao();
    } else {
        mostrarMensagem("Erro ao salvar.", "error");
    }
}

// ===================== produto DO PEDIDO =====================
function adicionarProduto() {
    const id = Number(produtoelect.value);
    const qtd = Number(quantidadeProduto.value);

    if (!id || qtd < 1) {
        return mostrarMensagem("Selecione um produto válido.", "error");
    }

    if (produtoelecionados.find(p => p.idProduto === id)) {
        return mostrarMensagem("Produto já adicionado!", "error");
    }

    const p = listaproduto.find(prod => prod.idproduto === id);

    produtoelecionados.push({
        idProduto: id,
        nomeProduto: p.nomeproduto,
        precoUnitario: parseFloat(p.precounitario),
        quantidade: qtd
    });

    atualizarTabelaproduto();
    calcularValorTotal();
}

function removerProduto(id) {
    produtoelecionados = produtoelecionados.filter(p => p.idProduto !== id);
    atualizarTabelaproduto();
    calcularValorTotal();
}

function atualizarTabelaproduto() {
    produtoTableBody.innerHTML = "";

    produtoelecionados.forEach(p => {
        const subtotal = p.precoUnitario * p.quantidade;

        produtoTableBody.innerHTML += `
            <tr>
                <td>${p.nomeProduto}</td>
                <td>R$ ${p.precoUnitario.toFixed(2)}</td>
                <td>${p.quantidade}</td>
                <td>R$ ${subtotal.toFixed(2)}</td>
                <td><button onclick="removerProduto(${p.idProduto})">Remover</button></td>
            </tr>
        `;
    });
}

function calcularValorTotal() {
    let total = 0;

    produtoelecionados.forEach(p => {
        total += p.precoUnitario * p.quantidade;
    });

    valorTotal.value = `R$ ${total.toFixed(2)}`;
}

// ===================== TABELA DE PEDIDOS =====================
async function carregarTabela() {
    try {
        const res = await fetch(API_URL);
        const pedidos = await res.json();

        pedidosTableBody.innerHTML = "";

        pedidos.forEach(p => {
            const data = new Date(p.datapedido).toLocaleDateString("pt-BR");
            const valor = parseFloat(p.valortotal).toFixed(2);

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${p.idpedido}</td>
                <td>${p.nomecliente || "N/A"}</td>
                <td>${p.nomeusuario || "N/A"}</td>
                <td>${data}</td>
                <td>R$ ${valor}</td>
            `;
            tr.onclick = () => {
                searchId.value = p.idpedido;
                buscarPedido();
            };

            pedidosTableBody.appendChild(tr);
        });

    } catch (err) {
        console.error("Erro ao carregar pedidos:", err);
    }
}

// ===================== UI HELPERS =====================
function habilitarFormulario() {
    idCliente.disabled = false;
    idUsuario.disabled = false;
    produtoelect.disabled = false;
    quantidadeProduto.disabled = false;
    btnAdicionarProduto.disabled = false;
}

function desabilitarFormulario() {
    idCliente.disabled = true;
    idUsuario.disabled = true;
    produtoelect.disabled = true;
    quantidadeProduto.disabled = true;
    btnAdicionarProduto.disabled = true;
}

function mostrarBotoesEdicao() {
    btnAlterar.style.display = "inline-block";
    btnExcluir.style.display = "inline-block";
    btnSalvar.style.display = "none";
}

function mostrarBotaoSalvar() {
    btnAlterar.style.display = "none";
    btnExcluir.style.display = "none";
    btnSalvar.style.display = "inline-block";
}

function esconderBotoesEdicao() {
    btnAlterar.style.display = "none";
    btnExcluir.style.display = "none";
    btnSalvar.style.display = "none";
}

function limparFormulario() {
    searchId.value = "";
    idCliente.value = "";
    idUsuario.value = "";
    produtoelect.value = "";
    quantidadeProduto.value = 1;
    produtoelecionados = [];
    atualizarTabelaproduto();
    calcularValorTotal();
}

function cancelarOperacao() {
    limparFormulario();
    desabilitarFormulario();
    esconderBotoesEdicao();
    modoEdicao = false;
    pedidoAtual = null;
}

// ===================== MENSAGENS =====================
function mostrarMensagem(texto, tipo) {
    const msg = document.createElement("div");
    msg.textContent = texto;
    msg.style.position = "fixed";
    msg.style.top = "20px";
    msg.style.right = "20px";
    msg.style.padding = "10px 15px";
    msg.style.borderRadius = "5px";
    msg.style.color = "#fff";
    msg.style.zIndex = 999;

    msg.style.background =
        tipo === "success" ? "#059669" :
        tipo === "error"   ? "#DC2626" :
                             "#2563EB";

    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 3000);
}

function voltarDashboard() {
    if (confirm("Voltar ao dashboard?")) {
        window.history.back();
    }
}
</script>
</body>
</html>
