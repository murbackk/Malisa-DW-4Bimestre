<!-- index.html corrigido completo - Zenite Store -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenite Store</title>
    <link rel="shortcut icon" href="backend/uploads/zenite_store_logo_star.png" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header">
        <div class="header-logo">
            <img src="backend/uploads/zenite_store_logo_star.png" alt="Zenite Store Logo">
            <div class="logo">Zenite Store</div>
        </div>

        <div class="user-section">
            <div id="welcomeSection" class="menu-wrapper" style="display: none;">
                <button id="menuBtn" class="menu-btn" aria-haspopup="true" aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span class="saudacao">Ol√°, <span id="nomeUsuario" style="font-weight:600;"></span></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="caret-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>

                <div id="menuDropdown" class="menu-dropdown" role="menu" aria-hidden="true">
                    <a id="menuGerenciarLink" class="menu-item" href="frontend/menu.html" style="display:none;">Gerenciar</a>
                    <a class="menu-item" href="frontend/navbar/contato.html">Contato</a>
                    <a class="menu-item" href="frontend/navbar/sobrenos.html">Sobre n√≥s</a>
                    <button id="menuSairBtn" class="menu-item menu-logout" style="color: crimson;">Sair</button>
                </div>
            </div>

            <div id="loginSection">
                <button class="btn btn-primary" onclick="goToLogin()">Login/Cadastro</button>
            </div>

            <button class="btn cart-btn" onclick="openCart()">
                Carrinho
                <span class="cart-count" id="cartCount">0</span>
            </button>
        </div>
    </div>

    <div class="container">
        <div id="alertContainer"></div>

        <section class="hero-section">
            <p class="hero-subtitle">Inspire-se para criar e crie para inspirar.</p>
            <h1 class="hero-title">Use Zenite.</h1>
            <p class="hero-description">A loja mais exclusiva da gal√°xia, aquela que atinge o ponto mais alto no c√©u, o √°pice, o topo.</p>
            <button class="btn btn-primary hero-btn" onclick="goToLogin()" id="loginbody">FAZER LOGIN</button>
        </section>

        <!-- BOT√ïES DE FILTRO -->
        <div class="filtro-categorias" style="display:flex; gap:10px; justify-content:center; margin:25px 0;">
            <button class="btn btn-primary" onclick="filtrarCategoria(1)">Roupas</button>
            <button class="btn btn-primary" onclick="filtrarCategoria(2)">Festa</button>
            <button class="btn btn-primary" onclick="filtrarCategoria(3)">Colecionador</button>
        </div>

        <div id="produtosContainer" class="produtos-grid"></div>
    </div>


    <!-- MODAL DO CARRINHO -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">MEU CARRINHO</h2>
                <button class="close-btn" onclick="closeCart()">&times;</button>
            </div>

            <div id="cartItems"></div>

            <div class="cart-total">Total: R$ <span id="cartTotalValue">0.00</span></div>
            <div class="cart-actions">
                <button class="btn btn-secondary" style="flex: 1;" onclick="finalizarCompra()">Finalizar Compra</button>
            </div>
        </div>
    </div>

    <footer class="zen-footer">
        <div class="zen-footer-content">
            <img src="backend/uploads/zenite_store_logo_star.png" class="zen-footer-logo">
            <p class="zen-footer-phrase">‚ÄúNo ponto mais alto, encontramos o que realmente brilha.‚Äù</p>
            <div class="zen-footer-links">
                <a href="frontend/navbar/sobrenos.html">Sobre n√≥s</a>
                <a href="frontend/navbar/contato.html">Contato</a>
                <a href="#produtosContainer">Roupas</a>
            </div>

            <div class="zen-footer-social">
                <a href="https://instagram.com/mariaelismurbk" target="_blank">Instagram</a>
                <a href="https://tiktok.com/@mariaelismurbk" target="_blank">TikTok</a>
                <a href="https://twitter.com/mariaelismurbk" target="_blank">Twitter</a>
            </div>
            <p class="zen-footer-copy">¬© 2025 Zenite Store ‚Ä¢ By MurbasLabs</p>
        </div>
    </footer>


<script>
//----------------------------------------------
// VARI√ÅVEIS GLOBAIS
//----------------------------------------------
let carrinho = [];
let produtos = [];
let usuarioLogado = null;
let categoriaSelecionada = null;

//----------------------------------------------
// CARREGAR AO INICIAR
//----------------------------------------------
window.addEventListener('load', () => {
    verificarLogin();
    carregarProdutos();
});

//----------------------------------------------
// LOGIN
//----------------------------------------------
function verificarLogin() {
    const user = localStorage.getItem('usuarioLogado');
    const nomeSpan = document.getElementById('nomeUsuario');
    atualizarSaudacao();

    if (user) {
        usuarioLogado = JSON.parse(user);
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('welcomeSection').style.display = 'flex';
        document.getElementById('loginbody').style.display = 'none';

        nomeSpan.textContent = usuarioLogado.nomeUsuario || 'Usu√°rio';

        verificarGerente(usuarioLogado.idUsuario);
    } else {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('welcomeSection').style.display = 'none';
    }
}

//----------------------------------------------
// GERENTE
//----------------------------------------------
async function verificarGerente(idUsuario) {
    try {
        const response = await fetch(`http://localhost:3001/login/verificarGerente?idusuario=${idUsuario}`);
        const data = await response.json();

        if (data.isGerente === true) {
            menuGerenciarLink.style.display = 'block';
        }
    } catch (error) {
        console.error('Erro ao verificar gerente:', error);
    }
}

//----------------------------------------------
// FILTRAR CATEGORIA
//----------------------------------------------
function filtrarCategoria(idCategoria) {
    categoriaSelecionada = idCategoria;
    console.log("Filtrando categoria:", idCategoria);
    renderizarProdutos();
}

//----------------------------------------------
// CARREGAR PRODUTOS
//----------------------------------------------
async function carregarProdutos() {
    try {
        const response = await fetch('http://localhost:3001/produto');
        const data = await response.json();
        produtos = Array.isArray(data) ? data : [];
        renderizarProdutos();
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
    }
}

//----------------------------------------------
// RENDERIZAR PRODUTOS (FINAL E CORRETO)
//----------------------------------------------
function renderizarProdutos() {
    const container = document.getElementById('produtosContainer');
    container.innerHTML = '';

    let lista = produtos;

    if (categoriaSelecionada !== null) {
        lista = produtos.filter(p => {
            const categoria = p.idcategoria || p.idCategoria || p.categoria_id;
            return Number(categoria) === Number(categoriaSelecionada);
        });
    }

    if (lista.length === 0) {
        container.innerHTML = '<p style="color:white; text-align:center;">Nenhum produto encontrado.</p>';
        return;
    }

    lista.forEach(produto => {
        const card = document.createElement('div');
        card.className = 'produto-card';

        card.innerHTML = `
            <div class="produto-imagem">
                ${produto.imagem
                    ? `<img src="http://localhost:3001/${produto.imagem}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`
                    : 'üì¶ Sem imagem'}
            </div>
            <h3 class="produto-nome">${produto.nomeproduto}</h3>
            <p class="produto-preco">R$ ${parseFloat(produto.precounitario).toFixed(2)}</p>
<div class="produto-actions">
    <input type="number" class="quantidade-input" value="1" min="1" id="qtd-${produto.idproduto}">
    <button class="btn-add-cart" onclick="adicionarAoCarrinho(${produto.idproduto})">Adicionar</button>
</div>
`;

        container.appendChild(card);
    }); // end lista.forEach
} // end renderizarProdutos

// ---------------------
// FUN√á√ïES DO CARRINHO
// ---------------------
function adicionarAoCarrinho(idProduto) {
    // aceita id como number ou string
    const produto = produtos.find(p => String(p.idproduto) === String(idProduto));
    const input = document.getElementById(`qtd-${idProduto}`);
    const quantidade = input ? parseInt(input.value, 10) || 1 : 1;

    if (!produto || quantidade < 1) return;

    const itemExistente = carrinho.find(item => String(item.idproduto) === String(idProduto));

    if (itemExistente) {
        itemExistente.quantidade += quantidade;
    } else {
        carrinho.push({
            idproduto: produto.idproduto,
            nomeproduto: produto.nomeproduto,
            precounitario: parseFloat(produto.precounitario) || 0,
            quantidade: quantidade
        });
    }

    atualizarCarrinho();
    mostrarAlerta('Produto adicionado ao carrinho!', 'success');
}

function atualizarCarrinho() {
    const count = carrinho.reduce((total, item) => total + (item.quantidade || 0), 0);
    const cartCountEl = document.getElementById('cartCount');
    if (cartCountEl) cartCountEl.textContent = count;
}

function openCart() {
    renderizarCarrinho();
    const modal = document.getElementById('cartModal');
    if (modal) modal.classList.add('active');
}

function closeCart() {
    const modal = document.getElementById('cartModal');
    if (modal) modal.classList.remove('active');
}

function renderizarCarrinho() {
    const container = document.getElementById('cartItems');
    if (!container) return;

    if (carrinho.length === 0) {
        container.innerHTML = '<div class="empty-cart">Seu carrinho est√° vazio</div>';
        document.getElementById('cartTotalValue').textContent = '0.00';
        return;
    }

    container.innerHTML = '';
    let total = 0;

    carrinho.forEach((item, index) => {
        const subtotal = (item.precounitario || 0) * (item.quantidade || 0);
        total += subtotal;

        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
            <div class="cart-item-info">
                <div class="cart-item-name">${item.nomeproduto}</div>
                <div class="cart-item-details">
                    Quantidade: ${item.quantidade} |
                    Pre√ßo: R$ ${Number(item.precounitario).toFixed(2)} |
                    Subtotal: R$ ${subtotal.toFixed(2)}
                </div>
            </div>
            <button class="cart-item-remove" onclick="removerDoCarrinho(${index})">Remover</button>
        `;
        container.appendChild(cartItem);
    });

    document.getElementById('cartTotalValue').textContent = total.toFixed(2);
}

function removerDoCarrinho(index) {
    if (index >= 0 && index < carrinho.length) {
        carrinho.splice(index, 1);
        atualizarCarrinho();
        renderizarCarrinho();
        mostrarAlerta('Produto removido do carrinho', 'success');
    }
}

// ---------------------
// FINALIZAR COMPRA
// ---------------------
async function finalizarCompra() {
    if (!usuarioLogado) {
        mostrarAlerta('Voc√™ precisa estar logado para finalizar a compra!', 'error');
        setTimeout(() => goToLogin(), 1200);
        return;
    }

    if (carrinho.length === 0) {
        mostrarAlerta('Seu carrinho est√° vazio!', 'error');
        return;
    }

    try {
        const pedidoData = {
            idCliente: usuarioLogado.idCliente || usuarioLogado.idCliente || null,
            idUsuario: usuarioLogado.idUsuario || null,
            produtos: carrinho.map(item => ({
                idProduto: item.idproduto,
                quantidade: item.quantidade,
                precoUnitario: item.precounitario
            }))
        };

        const response = await fetch('http://localhost:3001/pedido', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pedidoData)
        });

        const result = await response.json();

        if (response.ok) {
            localStorage.setItem('pedidoId', result.idPedido || result.idPedidoCriado || '');
            mostrarAlerta('Pedido registrado com sucesso!', 'success');
            carrinho = [];
            atualizarCarrinho();
            closeCart();
            // redireciona para pagamento se necess√°rio
            setTimeout(() => {
                window.location.href = 'frontend/pagamento/pagamento.html';
            }, 800);
        } else {
            throw new Error(result.message || 'Erro ao criar pedido');
        }
    } catch (error) {
        console.error('Erro ao finalizar compra:', error);
        mostrarAlerta('Erro ao finalizar compra. Tente novamente.', 'error');
    }
}

// ---------------------
// UTILIT√ÅRIOS (alertas, login, logout, menu)
// ---------------------
function mostrarAlerta(mensagem, tipo) {
    const container = document.getElementById('alertContainer');
    if (!container) return;
    container.innerHTML = `<div class="alert alert-${tipo} active">${mensagem}</div>`;
    setTimeout(() => { container.innerHTML = ''; }, 3000);
}

function goToLogin() {
    window.location.href = 'frontend/login/login.html';
}

function logout() {
    localStorage.removeItem('usuarioLogado');
    usuarioLogado = null;
    carrinho = [];
    atualizarCarrinho();
    verificarLogin(); // j√° existe fun√ß√£o acima
    mostrarAlerta('Logout realizado com sucesso!', 'success');
}

// ---------------------
// CONTROLES DO MENU (abrir/fechar, sair)
// ---------------------
const menuBtn = document.getElementById('menuBtn');
const menuDropdown = document.getElementById('menuDropdown');
const menuSairBtn = document.getElementById('menuSairBtn');
const menuGerenciarLink = document.getElementById('menuGerenciarLink');

if (menuBtn) {
    menuBtn.addEventListener('click', (e) => {
        const expanded = menuBtn.getAttribute('aria-expanded') === 'true';
        menuBtn.setAttribute('aria-expanded', (!expanded).toString());
        if (menuDropdown) menuDropdown.classList.toggle('show');
        if (menuDropdown) menuDropdown.setAttribute('aria-hidden', expanded ? 'true' : 'false');
    });
}

document.addEventListener('click', (e) => {
    if (!menuDropdown) return;
    if (!menuDropdown.classList.contains('show')) return;
    const target = e.target;
    if (!menuDropdown.contains(target) && menuBtn && !menuBtn.contains(target)) {
        menuDropdown.classList.remove('show');
        if (menuBtn) menuBtn.setAttribute('aria-expanded', 'false');
        menuDropdown.setAttribute('aria-hidden', 'true');
    }
});

if (menuSairBtn) {
    menuSairBtn.addEventListener('click', () => {
        logout();
        if (menuDropdown) menuDropdown.classList.remove('show');
        if (menuBtn) menuBtn.setAttribute('aria-expanded', 'false');
    });
}

// Atualiza sauda√ß√£o (se existir)
function atualizarSaudacao() {
    const user = localStorage.getItem('usuarioLogado');
    if (!user) return;
    const usuario = JSON.parse(user);
    const nomeUsuarioSpan = document.getElementById('nomeUsuario');
    if (!nomeUsuarioSpan) return;
    nomeUsuarioSpan.textContent = usuario.nomeUsuario || usuario.nome || 'Usu√°rio';
}
</script>
</body>
</html>
