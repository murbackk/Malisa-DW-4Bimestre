<!-- index.html com funcionalidade "Meus Pedidos" -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenite Store</title>
    <link rel="shortcut icon" href="backend/uploads/zenite_store_logo_star.png" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header">
        <div class="header-logo">
            <img src="backend/uploads/zenite_store_logo_star.png" alt="Zenite Store Logo">
            <div class="logo">Zenite Store</div>
        </div>

        <div class="user-section">
            <div id="welcomeSection" class="menu-wrapper" style="display: none;">
                <button id="menuBtn" class="menu-btn" aria-haspopup="true" aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span class="saudacao">Olá, <span id="nomeUsuario" style="font-weight:600;"></span></span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="caret-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>

                <div id="menuDropdown" class="menu-dropdown" role="menu" aria-hidden="true">
                    <a id="menuGerenciarLink" class="menu-item" href="frontend/menu.html" style="display:none;">Gerenciar</a>
                    <button class="menu-item" onclick="abrirMeusPedidos()">Meus Pedidos</button>
                    <a class="menu-item" href="frontend/navbar/contato.html">Contato</a>
                    <a class="menu-item" href="frontend/navbar/sobrenos.html">Sobre nós</a>
                    <button id="menuSairBtn" class="menu-item menu-logout" style="color: crimson;">Sair</button>
                </div>
            </div>

            <div id="loginSection">
                <button class="btn btn-primary" onclick="goToLogin()">Login/Cadastro</button>
            </div>

            <button class="btn cart-btn" onclick="openCart()">
                Carrinho
                <span class="cart-count" id="cartCount">0</span>
            </button>
        </div>
    </div>

    <div class="container">
        <div id="alertContainer"></div>

        <section class="hero-section">
            <p class="hero-subtitle">Inspire-se para criar e crie para inspirar.</p>
            <h1 class="hero-title">Use Zenite.</h1>
            <p class="hero-description">A loja mais exclusiva da galáxia, aquela que atinge o ponto mais alto no céu, o ápice, o topo.</p>
            <button class="btn btn-primary hero-btn" onclick="goToLogin()" id="loginbody">FAZER LOGIN</button>
        </section>

        <!-- BOTÕES DE FILTRO -->
        <div class="filtro-categorias" style="display:flex; gap:10px; justify-content:center; margin:25px 0;">
            <button class="btn btn-primary" onclick="filtrarCategoria(1)">Roupas</button>
            <button class="btn btn-primary" onclick="filtrarCategoria(2)">Festa</button>
            <button class="btn btn-primary" onclick="filtrarCategoria(3)">Colecionador</button>
        </div>

        <div id="produtosContainer" class="produtos-grid"></div>
    </div>


    <!-- MODAL DO CARRINHO -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">MEU CARRINHO</h2>
                <button class="close-btn" onclick="closeCart()">&times;</button>
            </div>

            <div id="cartItems"></div>

            <div class="cart-total">Total: R$ <span id="cartTotalValue">0.00</span></div>
            <div class="cart-actions">
                <button class="btn btn-secondary" style="flex: 1;" onclick="finalizarCompra()">Finalizar Compra</button>
            </div>
        </div>
    </div>

    <!-- MODAL MEUS PEDIDOS -->
    <div id="pedidosModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">MEUS PEDIDOS</h2>
                <button class="close-btn" onclick="fecharMeusPedidos()">&times;</button>
            </div>

            <div id="pedidosContainer"></div>
        </div>
    </div>

    <footer class="zen-footer">
        <div class="zen-footer-content">
            <img src="backend/uploads/zenite_store_logo_star.png" class="zen-footer-logo">
            <p class="zen-footer-phrase">"No ponto mais alto, encontramos o que realmente brilha."</p>
            <div class="zen-footer-links">
                <a href="frontend/navbar/sobrenos.html">Sobre nós</a>
                <a href="frontend/navbar/contato.html">Contato</a>
                <a href="#produtosContainer">Roupas</a>
            </div>

           <div class="zen-footer-social">
<a href="https://instagram.com/mariaelismurbk" target="_blank" aria-label="Instagram">
<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
<path d="M7 2C4.2 2 2 4.2 2 7v10c0 2.8 2.2 5 5 5h10c2.8 0 5-2.2 5-5V7c0-2.8-2.2-5-5-5H7zm10 2c1.7 0 3 1.3 3 3v10c0 1.7-1.3 3-3 3H7c-1.7 0-3-1.3-3-3V7c0-1.7 1.3-3 3-3h10zm-5 3.3A4.7 4.7 0 1 0 16.7 12 4.7 4.7 0 0 0 12 7.3zm0 7.7a3 3 0 1 1 3-3 3 3 0 0 1-3 3zm4.8-8.8a1.1 1.1 0 1 1-1.1-1.1 1.1 1.1 0 0 1 1.1 1.1z"/>
</svg>
</a>
<a href="https://tiktok.com/@mariaelismurbk" target="_blank" aria-label="TikTok">
<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
<path d="M12.75 2h3.25a5.76 5.76 0 0 0 5.75 5.75v3.25a9 9 0 0 1-5.75-1.98v7.73a6.75 6.75 0 1 1-6.75-6.75 6.5 6.5 0 0 1 1.5.17V14a3.5 3.5 0 1 0 2.25 3.28V2z"/>
</svg>
</a>
<a href="https://twitter.com/mariaelismurbk" target="_blank" aria-label="Twitter">
<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
<path d="M19.6 3H16l-4 5-4-5H3.8l6.2 7.5L3.4 21h3.6l4.6-6 4.4 6h3.6l-6.4-7.8L19.6 3z"/>
</svg>
</a>
</div>
            <p class="zen-footer-copy">© 2025 Zenite Store • By MurbasLabs</p>
        </div>
    </footer>


<script>
//----------------------------------------------
// VARIÁVEIS GLOBAIS
//----------------------------------------------
let carrinho = [];
let produtos = [];
let usuarioLogado = null;
let categoriaSelecionada = null;

//----------------------------------------------
// CARREGAR AO INICIAR
//----------------------------------------------
window.addEventListener('load', () => {
    verificarLogin();
    carregarProdutos();
});

//----------------------------------------------
// LOGIN
//----------------------------------------------
function verificarLogin() {
    const user = localStorage.getItem('usuarioLogado');
    const nomeSpan = document.getElementById('nomeUsuario');
    atualizarSaudacao();

    if (user) {
        usuarioLogado = JSON.parse(user);
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('welcomeSection').style.display = 'flex';
        document.getElementById('loginbody').style.display = 'none';

        nomeSpan.textContent = usuarioLogado.nomeUsuario || 'Usuário';

        verificarGerente(usuarioLogado.idUsuario);
    } else {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('welcomeSection').style.display = 'none';
    }
}

//----------------------------------------------
// GERENTE
//----------------------------------------------
async function verificarGerente(idUsuario) {
    try {
        const response = await fetch(`http://localhost:3001/login/verificarGerente?idusuario=${idUsuario}`);
        const data = await response.json();

        if (data.isGerente === true) {
            menuGerenciarLink.style.display = 'block';
        }
    } catch (error) {
        console.error('Erro ao verificar gerente:', error);
    }
}

//----------------------------------------------
// FILTRAR CATEGORIA
//----------------------------------------------
function filtrarCategoria(idCategoria) {
    categoriaSelecionada = idCategoria;
    console.log("Filtrando categoria:", idCategoria);
    renderizarProdutos();
}

//----------------------------------------------
// CARREGAR PRODUTOS
//----------------------------------------------
async function carregarProdutos() {
    try {
        const response = await fetch('http://localhost:3001/produto');
        const data = await response.json();
        produtos = Array.isArray(data) ? data : [];
        renderizarProdutos();
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
    }
}

//----------------------------------------------
// RENDERIZAR PRODUTOS
//----------------------------------------------
function renderizarProdutos() {
    const container = document.getElementById('produtosContainer');
    container.innerHTML = '';

    let lista = produtos;

    if (categoriaSelecionada !== null) {
        lista = produtos.filter(p => {
            const categoria = p.idcategoria || p.idCategoria || p.categoria_id;
            return Number(categoria) === Number(categoriaSelecionada);
        });
    }

    if (lista.length === 0) {
        container.innerHTML = '<p style="color:white; text-align:center;">Nenhum produto encontrado.</p>';
        return;
    }

    lista.forEach(produto => {
        const card = document.createElement('div');
        card.className = 'produto-card';

        card.innerHTML = `
            <div class="produto-imagem">
                ${produto.imagem
                    ? `<img src="http://localhost:3001/${produto.imagem}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`
                    : '✨'}
            </div>
            <h3 class="produto-nome">${produto.nomeproduto}</h3>
            <p class="produto-preco">R$ ${parseFloat(produto.precounitario).toFixed(2)}</p>
<div class="produto-actions">
    <input type="number" class="quantidade-input" value="1" min="1" id="qtd-${produto.idproduto}">
    <button class="btn-add-cart" onclick="adicionarAoCarrinho(${produto.idproduto})">Adicionar</button>
</div>
`;

        container.appendChild(card);
    });
}

// ---------------------
// FUNÇÕES DO CARRINHO
// ---------------------
function adicionarAoCarrinho(idProduto) {
    const produto = produtos.find(p => String(p.idproduto) === String(idProduto));
    const input = document.getElementById(`qtd-${idProduto}`);
    const quantidade = input ? parseInt(input.value, 10) || 1 : 1;

    if (!produto || quantidade < 1) return;

    const itemExistente = carrinho.find(item => String(item.idproduto) === String(idProduto));

    if (itemExistente) {
        itemExistente.quantidade += quantidade;
    } else {
        carrinho.push({
            idproduto: produto.idproduto,
            nomeproduto: produto.nomeproduto,
            precounitario: parseFloat(produto.precounitario) || 0,
            quantidade: quantidade
        });
    }

    atualizarCarrinho();
    mostrarAlerta('Produto adicionado ao carrinho!', 'success');
}

function atualizarCarrinho() {
    const count = carrinho.reduce((total, item) => total + (item.quantidade || 0), 0);
    const cartCountEl = document.getElementById('cartCount');
    if (cartCountEl) cartCountEl.textContent = count;
}

function openCart() {
    renderizarCarrinho();
    const modal = document.getElementById('cartModal');
    if (modal) modal.classList.add('active');
}

function closeCart() {
    const modal = document.getElementById('cartModal');
    if (modal) modal.classList.remove('active');
}

function renderizarCarrinho() {
    const container = document.getElementById('cartItems');
    if (!container) return;

    if (carrinho.length === 0) {
        container.innerHTML = '<div class="empty-cart">Seu carrinho está vazio</div>';
        document.getElementById('cartTotalValue').textContent = '0.00';
        return;
    }

    container.innerHTML = '';
    let total = 0;

    carrinho.forEach((item, index) => {
        const subtotal = (item.precounitario || 0) * (item.quantidade || 0);
        total += subtotal;

        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
            <div class="cart-item-info">
                <div class="cart-item-name">${item.nomeproduto}</div>
                <div class="cart-item-details">
                    Quantidade: ${item.quantidade} |
                    Preço: R$ ${Number(item.precounitario).toFixed(2)} |
                    Subtotal: R$ ${subtotal.toFixed(2)}
                </div>
            </div>
            <button class="cart-item-remove" onclick="removerDoCarrinho(${index})">Remover</button>
        `;
        container.appendChild(cartItem);
    });

    document.getElementById('cartTotalValue').textContent = total.toFixed(2);
}

function removerDoCarrinho(index) {
    if (index >= 0 && index < carrinho.length) {
        carrinho.splice(index, 1);
        atualizarCarrinho();
        renderizarCarrinho();
        mostrarAlerta('Produto removido do carrinho', 'success');
    }
}

// ---------------------
// FINALIZAR COMPRA
// ---------------------
async function finalizarCompra() {
    if (!usuarioLogado) {
        mostrarAlerta('Você precisa estar logado para finalizar a compra!', 'error');
        setTimeout(() => goToLogin(), 1200);
        return;
    }

    if (carrinho.length === 0) {
        mostrarAlerta('Seu carrinho está vazio!', 'error');
        return;
    }

    try {
        const pedidoData = {
            idCliente: usuarioLogado.idCliente || usuarioLogado.idCliente || usuarioLogado.idUsuario || null,
            idUsuario: usuarioLogado.idUsuario || null,
            produtos: carrinho.map(item => ({
                idProduto: item.idproduto,
                quantidade: item.quantidade,
                precoUnitario: item.precounitario
            }))
        };

        const response = await fetch('http://localhost:3001/pedido', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pedidoData)
        });

        const result = await response.json();

        if (response.ok) {
            localStorage.setItem('pedidoId', result.idPedido || result.idPedidoCriado || '');
            mostrarAlerta('Pedido registrado com sucesso!', 'success');
            carrinho = [];
            atualizarCarrinho();
            closeCart();
            setTimeout(() => {
                window.location.href = 'frontend/pagamento/pagamento.html';
            }, 800);
        } else {
            throw new Error(result.message || 'Erro ao criar pedido');
        }
    } catch (error) {
        console.error('Erro ao finalizar compra:', error);
        mostrarAlerta('Erro ao finalizar compra. Tente novamente.', 'error');
    }
}

// ---------------------
// MEUS PEDIDOS
// ---------------------
async function abrirMeusPedidos() {
    if (!usuarioLogado) {
        mostrarAlerta('Você precisa estar logado!', 'error');
        return;
    }

    // Fecha o menu dropdown
    const menuDropdown = document.getElementById('menuDropdown');
    if (menuDropdown) {
        menuDropdown.classList.remove('show');
        const menuBtn = document.getElementById('menuBtn');
        if (menuBtn) menuBtn.setAttribute('aria-expanded', 'false');
    }

    // Abre o modal
    const modal = document.getElementById('pedidosModal');
    if (modal) modal.classList.add('active');

    // Carrega os pedidos
    await carregarPedidosUsuario();
}

function fecharMeusPedidos() {
    const modal = document.getElementById('pedidosModal');
    if (modal) modal.classList.remove('active');
}

async function carregarPedidosUsuario() {
    const container = document.getElementById('pedidosContainer');
    if (!container) return;

    container.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Carregando pedidos...</div>';

    try {
        // Busca todos os pedidos
        const response = await fetch('http://localhost:3001/pedido');
        const todosPedidos = await response.json();

        console.log('=== DEBUG PEDIDOS ===');
        console.log('Usuário logado:', usuarioLogado);
        console.log('Todos os pedidos:', todosPedidos);

        // Se não houver pedidos
        if (!Array.isArray(todosPedidos) || todosPedidos.length === 0) {
            container.innerHTML = '<div class="empty-cart">Nenhum pedido encontrado no sistema</div>';
            return;
        }

        // Filtra pedidos do usuário logado pelo idcliente (minúsculo!)
        const idClienteUsuario = usuarioLogado.idCliente || usuarioLogado.idcliente || usuarioLogado.idUsuario;
        const pedidosUsuario = todosPedidos.filter(pedido => {
            const idClientePedido = pedido.idcliente || pedido.idCliente;
            return Number(idClientePedido) === Number(idClienteUsuario);
        });

        console.log('ID Cliente do usuário:', idClienteUsuario);
        console.log('Pedidos filtrados:', pedidosUsuario);

        if (pedidosUsuario.length === 0) {
            container.innerHTML = '<div class="empty-cart">Você ainda não fez nenhum pedido</div>';
            return;
        }

        container.innerHTML = '';

        // Renderiza cada pedido
        for (const pedido of pedidosUsuario) {
            await renderizarPedido(pedido, container);
        }

    } catch (error) {
        console.error('Erro ao carregar pedidos:', error);
        container.innerHTML = '<div class="empty-cart">Erro ao carregar pedidos. Tente novamente.</div>';
    }
}

async function renderizarPedido(pedido, container) {
    const pedidoDiv = document.createElement('div');
    pedidoDiv.className = 'pedido-card';
    
    const idPedido = pedido.idpedido || pedido.idPedido;
    const dataPedido = pedido.datapedido || pedido.dataPedido;
    const valorTotal = parseFloat(pedido.valortotal || pedido.valorTotal || 0);

    // Busca os itens do pedido
    try {
        const responseItens = await fetch(`http://localhost:3001/pedidoproduto/${idPedido}`);
        const itens = await responseItens.json();

        let itensHTML = '';
        
        if (Array.isArray(itens) && itens.length > 0) {
            for (const item of itens) {
                const idProduto = item.idproduto || item.idProduto;
                const nomeProduto = item.nomeproduto || item.nomeProduto || 'Produto';
                const quantidade = item.quantidade || 0;
                const precoUnitario = parseFloat(item.precounitario || item.precoUnitario || 0);
                const subtotal = quantidade * precoUnitario;

                // Busca informações do produto para pegar a imagem
                let imagemProduto = '';
                try {
                    const produtoResponse = await fetch(`http://localhost:3001/produto/${idProduto}`);
                    const produto = await produtoResponse.json();
                    imagemProduto = produto.imagem || '';
                } catch (err) {
                    console.error('Erro ao buscar produto:', err);
                }

                itensHTML += `
                    <div class="pedido-item">
                        <div class="pedido-item-img">
                            ${imagemProduto 
                                ? `<img src="http://localhost:3001/${imagemProduto}" alt="${nomeProduto}">`
                                : '<div style="width:60px;height:60px;background:#f0f0f0;border-radius:8px;display:flex;align-items:center;justify-content:center;">✨</div>'
                            }
                        </div>
                        <div class="pedido-item-info">
                            <div class="pedido-item-nome">${nomeProduto}</div>
                            <div class="pedido-item-detalhes">
                                Qtd: ${quantidade} | Preço: R$ ${precoUnitario.toFixed(2)} | Subtotal: R$ ${subtotal.toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
            }
        } else {
            itensHTML = '<p style="color:#999; text-align:center;">Nenhum item encontrado</p>';
        }

        pedidoDiv.innerHTML = `
            <div class="pedido-header">
                <div>
                    <div class="pedido-numero">Pedido #${idPedido}</div>
                    <div class="pedido-data">${new Date(dataPedido).toLocaleDateString('pt-BR')}</div>
                </div>
                <div class="pedido-total">R$ ${valorTotal.toFixed(2)}</div>
            </div>
            <div class="pedido-itens">
                ${itensHTML}
            </div>
        `;

        container.appendChild(pedidoDiv);

    } catch (error) {
        console.error('Erro ao buscar itens do pedido:', error);
        pedidoDiv.innerHTML = `
            <div class="pedido-header">
                <div>
                    <div class="pedido-numero">Pedido #${idPedido}</div>
                    <div class="pedido-data">${new Date(dataPedido).toLocaleDateString('pt-BR')}</div>
                </div>
                <div class="pedido-total">R$ ${valorTotal.toFixed(2)}</div>
            </div>
            <p style="color:#999; padding:15px;">Erro ao carregar itens do pedido</p>
        `;
        container.appendChild(pedidoDiv);
    }
}

// ---------------------
// UTILITÁRIOS
// ---------------------
function mostrarAlerta(mensagem, tipo) {
    const container = document.getElementById('alertContainer');
    if (!container) return;
    container.innerHTML = `<div class="alert alert-${tipo} active">${mensagem}</div>`;
    setTimeout(() => { container.innerHTML = ''; }, 3000);
}

function goToLogin() {
    window.location.href = 'frontend/login/login.html';
}

function logout() {
    localStorage.removeItem('usuarioLogado');
    usuarioLogado = null;
    carrinho = [];
    atualizarCarrinho();
    verificarLogin();
    mostrarAlerta('Logout realizado com sucesso!', 'success');
}

// ---------------------
// CONTROLES DO MENU
// ---------------------
const menuBtn = document.getElementById('menuBtn');
const menuDropdown = document.getElementById('menuDropdown');
const menuSairBtn = document.getElementById('menuSairBtn');
const menuGerenciarLink = document.getElementById('menuGerenciarLink');

if (menuBtn) {
    menuBtn.addEventListener('click', (e) => {
        const expanded = menuBtn.getAttribute('aria-expanded') === 'true';
        menuBtn.setAttribute('aria-expanded', (!expanded).toString());
        if (menuDropdown) menuDropdown.classList.toggle('show');
        if (menuDropdown) menuDropdown.setAttribute('aria-hidden', expanded ? 'true' : 'false');
    });
}

document.addEventListener('click', (e) => {
    if (!menuDropdown) return;
    if (!menuDropdown.classList.contains('show')) return;
    const target = e.target;
    if (!menuDropdown.contains(target) && menuBtn && !menuBtn.contains(target)) {
        menuDropdown.classList.remove('show');
        if (menuBtn) menuBtn.setAttribute('aria-expanded', 'false');
        menuDropdown.setAttribute('aria-hidden', 'true');
    }
});

if (menuSairBtn) {
    menuSairBtn.addEventListener('click', () => {
        logout();
        if (menuDropdown) menuDropdown.classList.remove('show');
        if (menuBtn) menuBtn.setAttribute('aria-expanded', 'false');
    });
}

function atualizarSaudacao() {
    const user = localStorage.getItem('usuarioLogado');
    if (!user) return;
    const usuario = JSON.parse(user);
    const nomeUsuarioSpan = document.getElementById('nomeUsuario');
    if (!nomeUsuarioSpan) return;
    nomeUsuarioSpan.textContent = usuario.nomeUsuario || usuario.nome || 'Usuário';
}
</script>
</body>
</html>